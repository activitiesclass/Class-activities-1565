<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø±ÙˆÙ (30 Ø­Ø±Ù) - Ù†Ø³Ø®Ø© Ù…Ø¹Ø¯Ù„Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/notification-bar.css">
  <style>
    :root{
      --oman-red:#DC143C;--oman-green:#228B22;--oman-gold:#FFD700;--oman-white:#fff;--oman-navy:#1B365D;
      --red-gradient:linear-gradient(135deg,#DC143C 0%,#B91C3C 50%,#991B1B 100%);
      --green-gradient:linear-gradient(135deg,#228B22 0%,#16A34A 50%,#15803D 100%);
      --navy-gradient:linear-gradient(135deg,#1B365D 0%,#1E40AF 50%,#1D4ED8 100%);
      --bg-primary:#F8FAFC;--bg-secondary:#F1F5F9;--text-primary:#0F172A;--text-secondary:#475569;--border-color:#E2E8F0;
      --shadow-light:0 1px 3px rgba(0,0,0,.1);--shadow-medium:0 4px 6px rgba(0,0,0,.1);--shadow-large:0 10px 15px rgba(0,0,0,.1);
      --transition-fast:.15s ease;--transition-normal:.3s ease;--transition-slow:.5s ease;
      --font-family:'Cairo',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--font-family);background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden}
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .game-header{margin:1rem 0;padding:1.5rem;background:#fff;border:1px solid var(--border-color);border-radius:18px;box-shadow:var(--shadow-medium);text-align:center}
    .game-title{font-size:2rem;font-weight:800;background:var(--red-gradient);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .game-subtitle{margin-top:.35rem;color:var(--text-secondary)}
    .settings{background:#fff;border:1px solid var(--border-color);border-radius:18px;box-shadow:var(--shadow-medium);padding:1.25rem}
    .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-bottom:1rem}
    .setting-group{display:flex;flex-direction:column;gap:.4rem}
    .setting-group label{font-weight:700}
    select,input{padding:.8rem;border:2px solid var(--border-color);border-radius:12px;font-family:var(--font-family)}
    select:focus,input:focus{outline:none;border-color:var(--oman-red);box-shadow:0 0 0 3px rgba(220,20,60,.1)}
    .action-buttons{display:flex;gap:.75rem;flex-wrap:wrap;justify-content:center}
    .btn{border:none;border-radius:12px;padding:.9rem 1.4rem;font-weight:700;cursor:pointer;transition:var(--transition-normal)}
    .btn.primary{background:var(--red-gradient);color:#fff}
    .btn.secondary{background:var(--navy-gradient);color:#fff}
    .btn.success{background:var(--green-gradient);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .game-area{display:grid;grid-template-columns:1fr 2fr 1fr;gap:1rem;margin-top:1rem}
    .team{background:#fff;border-radius:18px;border:3px solid var(--oman-green);padding:1rem;box-shadow:var(--shadow-medium);position:relative}
    .team.red{border-color:var(--oman-red)}
    .team .name{font-weight:800}
    .team .score{font-size:2rem;font-weight:900;margin:.5rem 0}
    .team .hint{color:var(--text-secondary);font-size:.95rem}
    .board{background:#fff;border:1px solid var(--border-color);border-radius:18px;box-shadow:var(--shadow-medium);padding:1rem}
    .board h3{text-align:center;margin-bottom:.75rem}
    /* 30 Ø®Ù„ÙŠØ© = 6Ã—5 */
    .hexagon-board{display:grid;grid-template-columns:repeat(6,1fr);gap:.45rem;max-width:640px;margin:0 auto}
    .cell{aspect-ratio:1;background:var(--bg-secondary);border:3px solid var(--border-color);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:800;cursor:pointer;transition:var(--transition-normal);user-select:none}
    .cell:hover{transform:translateY(-2px);box-shadow:var(--shadow-medium);border-color:var(--oman-gold)}
    .cell.taken-green{background:var(--green-gradient);border-color:var(--oman-green);color:#fff}
    .cell.taken-red{background:var(--red-gradient);border-color:var(--oman-red);color:#fff}
    .hidden{display:none !important}
    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:1rem;z-index:50}
    .overlay.show{display:flex}
    .modal{background:#fff;border-radius:16px;box-shadow:var(--shadow-large);max-width:560px;width:100%;padding:1rem 1.25rem}
    .modal .title{font-weight:800;font-size:1.25rem;margin-bottom:.75rem}
    .modal .actions{display:flex;gap:.5rem;justify-content:center;margin-top:1rem;flex-wrap:wrap}
    .team-btn{padding:.8rem 1.2rem;border:none;border-radius:12px;color:#fff;font-weight:800;cursor:pointer}
    .team-btn.green{background:var(--green-gradient)}
    .team-btn.red{background:var(--red-gradient)}
    .options{display:grid;grid-template-columns:1fr;gap:.5rem;margin-top:.75rem}
    .opt{padding:.8rem 1rem;border:2px solid var(--border-color);border-radius:12px;background:#fff;cursor:pointer;text-align:right;font-weight:700}
    .opt:hover{border-color:var(--oman-red)}
    .opt.correct{background:var(--green-gradient);border-color:var(--oman-green);color:#fff}
    .opt.wrong{background:var(--red-gradient);border-color:var(--oman-red);color:#fff}
    .close{background:#eee;border:none;border-radius:10px;padding:.5rem .8rem;cursor:pointer}
    @media (max-width: 1024px){.game-area{grid-template-columns:1fr;gap:1rem}.hexagon-board{max-width:520px}}
    @media (max-width: 480px){.hexagon-board{max-width:320px}.cell{font-size:1.1rem;border-radius:12px}}
  </style>
</head>
<body>
  <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© -->
  <audio id="clickSound" src="../assets/media/sounds/Click.mp3" preload="auto"></audio>
  <audio id="successSound" src="../assets/media/sounds/name-start.mp3" preload="auto"></audio>
  <audio id="winSound" src="../assets/media/sounds/win.mp3" preload="auto"></audio>
  <audio id="winBlockbustersSound" src="../assets/media/sounds/win-Blockbusters.mp3" preload="auto"></audio>
  <audio id="greenPointSound" src="../assets/media/sounds/g.mp3" preload="auto"></audio>
  <audio id="redPointSound" src="../assets/media/sounds/r.mp3" preload="auto"></audio>

  <div class="container">
     <!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ø§Ø¦Ù…Ø© -->
     <div id="notificationBar" class="notification-bar hidden"></div>
     <div class="game-header">
      <div class="game-title">ğŸ§© Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø±ÙˆÙ â€” Ù†Ø³Ø®Ø© 30 Ø­Ø±Ù</div>
      <div class="game-subtitle">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø± ÙŠÙÙˆØ² Ø¨Ø¥ÙƒÙ…Ø§Ù„ ØµÙ Ø£ÙÙ‚ÙŠ â€¢ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± ÙŠÙÙˆØ² Ø¨Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…ÙˆØ¯ Ø±Ø£Ø³ÙŠ</div>
    </div>

    <div class="settings" id="settingsPanel">
      <div class="settings-grid">
        <div class="setting-group">
          <label>ğŸ« Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
          <select id="stageSelect" required>
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
            <option value="Ø§Ù„Ø®Ø§Ù…Ø³">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option>
            <option value="Ø§Ù„Ø³Ø§Ø¯Ø³">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
            <option value="Ø§Ù„Ø³Ø§Ø¨Ø¹">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹</option>
            <option value="Ø§Ù„Ø«Ø§Ù…Ù†">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†</option>
            <option value="Ø§Ù„ØªØ§Ø³Ø¹">Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹</option>
          </select>
        </div>
        <div class="setting-group">
          <label>â±ï¸ Ø²Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</label>
          <select id="answerTimeSelect">
            <option value="unlimited">Ù…ÙØªÙˆØ­</option>
            <option value="limited">Ù…Ø­Ø¯Ø¯</option>
          </select>
          <input type="number" id="answerTimeInput" min="5" max="300" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (Ù…Ø«Ù„Ø§Ù‹ 30)" style="margin-top:.5rem;display:none">
        </div>
      </div>
      <div class="action-buttons">
        <button class="btn primary" id="startGameBtn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        <button class="btn secondary" id="resetBtn">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>
      <p style="margin-top:.75rem;color:var(--text-secondary)">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŒ Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙˆÙ…Ù„Ù <b>questions_bank.json</b> ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯.
      </p>
    </div>

    <div class="game-area hidden" id="gameArea">
      <div class="team" id="greenTeam">
        <div class="name">ğŸŸ¢ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±</div>
        <div class="score" id="greenScore">0</div>
        <div class="hint">ğŸ¯ Ø£ÙƒÙ…Ù„ ØµÙØ§Ù‹ Ø£ÙÙ‚ÙŠØ§Ù‹ Ù„Ù„ÙÙˆØ²</div>
      </div>

      <div class="board">
        <h3>ğŸ² Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø±ÙˆÙ (6 Ã— 5)</h3>
        <div class="hexagon-board" id="board"></div>
      </div>

      <div class="team red" id="redTeam">
        <div class="name">ğŸ”´ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
        <div class="score" id="redScore">0</div>
        <div class="hint">ğŸ¯ Ø£ÙƒÙ…Ù„ Ø¹Ù…ÙˆØ¯Ø§Ù‹ Ø±Ø£Ø³ÙŠØ§Ù‹ Ù„Ù„ÙÙˆØ²</div>
      </div>
    </div>
  </div>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ -->
  <div class="overlay" id="teamModal">
    <div class="modal">
      <div class="title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚</div>
      <p style="color:var(--text-secondary)">Ø£ÙŠ ÙØ±ÙŠÙ‚ Ø³ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø±ÙØŸ</p>
      <div class="actions">
        <button class="team-btn green" id="chooseGreen">ğŸŸ¢ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±</button>
        <button class="team-btn red" id="chooseRed">ğŸ”´ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</button>
      </div>
      <div class="actions"><button class="close" data-close="#teamModal">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <!-- Ø³Ø¤Ø§Ù„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª -->
  <div class="overlay" id="questionModal">
    <div class="modal">
      <div class="title" id="qTitle">Ø§Ù„Ø³Ø¤Ø§Ù„</div>
      <div id="questionText" style="font-weight:700"></div>
      <div class="options" id="options"></div>
      <div id="timer" style="text-align:center;margin-top:.5rem;color:var(--text-secondary)"></div>
      <div class="actions"><button class="close" data-close="#questionModal">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>


  <!-- ÙÙˆØ² Ø§Ø­ØªØ±Ø§ÙÙŠ -->
  <div class="overlay" id="victoryModal">
    <div class="modal victory-modal">
      <div class="modal-header">
        <div class="modal-title" id="victoryTitle">ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</div>
        <button class="close" data-close="#victoryModal">âœ•</button>
      </div>
      <div class="victory-animation">ğŸ†</div>
      <div class="victory-title" id="victoryMsg">Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø²!</div>
      <div class="victory-players" id="victoryPlayers"></div>
      <div class="honor-board">
        <div class="honor-title">ğŸ… Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</div>
        <div class="honor-list" id="honorList"></div>
      </div>
      <div class="actions">
        <button class="btn success" data-close="#victoryModal">ğŸ® Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
    </div>
  </div>

<script>
// ======== Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ========
const soundElements = {
  click: document.getElementById('clickSound'),
  success: document.getElementById('successSound'),
  win: document.getElementById('winSound'),
  winBlockbusters: document.getElementById('winBlockbustersSound'),
  greenPoint: document.getElementById('greenPointSound'),
  redPoint: document.getElementById('redPointSound')
};
let soundEnabled = true;

function playSound(type, autoMuteAfter = null) {
  if (!soundEnabled || !soundElements[type]) return;
  try {
    const sound = soundElements[type];
    sound.currentTime = 0;
    sound.volume = 0.7;
    const playPromise = sound.play();
    if (playPromise !== undefined) {
      playPromise.then(() => {
        if (autoMuteAfter && typeof autoMuteAfter === 'number') {
          setTimeout(() => {
            if (!sound.paused) {
              sound.pause();
              sound.currentTime = 0;
            }
          }, autoMuteAfter);
        }
      }).catch(() => {});
    }
  } catch (error) {}
}

function playWinSoundSequence() {
  if (!soundEnabled) return;
  if (soundElements.win) {
    soundElements.win.currentTime = 0;
    soundElements.win.volume = 0.7;
    const playFirstSound = soundElements.win.play();
    if (playFirstSound !== undefined) {
      playFirstSound.then(() => {
        const playSecondSound = () => {
          if (soundElements.winBlockbusters && soundEnabled) {
            soundElements.winBlockbusters.currentTime = 0;
            soundElements.winBlockbusters.volume = 0.7;
            soundElements.winBlockbusters.play();
          }
        };
        soundElements.win.addEventListener('ended', playSecondSound, { once: true });
        setTimeout(() => {
          if (soundElements.win.paused || soundElements.win.ended) {
            playSecondSound();
          }
        }, 3000);
      });
    }
  } else {
    playSound('winBlockbusters');
  }
}
// ======== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ========
const letters30 = ["Ø§","Ø¨","Øª","Ø«","Ø¬","Ø­","Ø®","Ø¯","Ø°","Ø±","Ø²","Ø³","Ø´","Øµ","Ø¶","Ø·","Ø¸","Ø¹","Øº","Ù","Ù‚","Ùƒ","Ù„","Ù…","Ù†","Ù‡","Ùˆ","ÙŠ","Ø©","Ø¡"];
const COLS = 6, ROWS = 5; // 6Ã—5 = 30 Ø®Ù„Ø§ÙŠØ§
let currentStage = "";
let boardState = Array.from({length: ROWS}, () => Array(COLS).fill(null)); // null | 'green' | 'red'
let selectedCell = null; // {row, col, el}
let currentTeam = null; // 'green' | 'red'
let questionsData = [];
let timerId = null;
// Removed legacy playNotificationSound function to avoid context error and allow new sound system to work.
const questionModal = document.getElementById("questionModal");
const qTitle = document.getElementById("qTitle");
const questionText = document.getElementById("questionText");
const optionsEl = document.getElementById("options");
const timerEl = document.getElementById("timer");

const victoryModal = document.getElementById("victoryModal");
const victoryTitle = document.getElementById("victoryTitle");
const victoryMsg = document.getElementById("victoryMsg");

// ======== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ========
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function show(el){ el.classList.add("show"); }
function hide(el){ el.classList.remove("show"); }
function openOverlay(id){ document.querySelector(id).classList.add("show"); }
function closeOverlay(id){ document.querySelector(id).classList.remove("show"); }

document.querySelectorAll(".close").forEach(btn=>{
  btn.addEventListener("click", e => closeOverlay(btn.getAttribute("data-close")));
});

// ======== ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ========
let bankByStage = {};
fetch("questions_bank.json")
  .then(r => r.json())
  .then(json => {
    const arr = json["Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©"] || [];
    arr.forEach(group => {
      bankByStage[group["Ø§Ù„ØµÙ"]] = group["Ø§Ù„Ø£Ø³Ø¦Ù„Ø©"];
    });
  })
  .catch(err => {
    console.error("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:", err);
    alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (questions_bank.json). Ø¶Ø¹ Ø§Ù„Ù…Ù„Ù Ø¨Ø¬ÙˆØ§Ø± Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
  });

// ======== Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø© 30 Ø­Ø±Ù ========
function createBoard(){
  boardEl.innerHTML = "";
  const shuffledLetters = shuffle(letters30);
  let idx = 0;
  for(let r=0; r<ROWS; r++){
    for(let c=0; c<COLS; c++){
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.setAttribute("data-r", r);
      cell.setAttribute("data-c", c);
      cell.textContent = shuffledLetters[idx++];

      cell.addEventListener("click", () => onCellClick(cell, r, c));
      boardEl.appendChild(cell);
    }
  }
}

// ======== Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ========
startGameBtn.addEventListener("click", () => {
  currentStage = stageSelect.value;
  if(!currentStage){
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }
  // Ø´Ø±Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø¹Ù†Ø¯Ù…Ø§ ØªØ®ØªØ§Ø± Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
  // (Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙØŒ Ù„ÙƒÙ† Ø§Ù„Ø®Ø§Ù…Ø³ Ù…Ø¶Ù…ÙˆÙ†).
  if(!bankByStage[currentStage] || bankByStage[currentStage].length === 0){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙÙŠ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.");
    return;
  }
  settingsPanel.classList.add("hidden");
  gameArea.classList.remove("hidden");
  resetGameState();
  createBoard();
});

resetBtn.addEventListener("click", () => {
  location.reload();
});

// Ø²Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
const answerTimeSelect = document.getElementById("answerTimeSelect");
const answerTimeInput = document.getElementById("answerTimeInput");
answerTimeSelect.addEventListener("change", () => {
  answerTimeInput.style.display = answerTimeSelect.value === "limited" ? "block" : "none";
});

// ======== Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø®Ù„ÙŠØ© ========
function onCellClick(cell, r, c){
  // Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø± Ø®Ù„ÙŠØ© Ù…Ø­Ø¬ÙˆØ²Ø©
  if(boardState[r][c]) return;
  selectedCell = {row:r, col:c, el:cell};
  openOverlay("#teamModal");
}

chooseGreen.addEventListener("click", () => { currentTeam = "green"; closeOverlay("#teamModal"); askQuestion(); });
chooseRed.addEventListener("click", () => { currentTeam = "red"; closeOverlay("#teamModal"); askQuestion(); });

// ======== Ø¹Ø±Ø¶ Ø³Ø¤Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ========
function askQuestion(){
  const list = bankByStage[currentStage] || [];
  if(list.length === 0){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©.");
    return;
  }
  const q = list[Math.floor(Math.random()*list.length)];
  renderQuestion(q);
}

function renderQuestion(q){
  qTitle.textContent = `Ø³Ø¤Ø§Ù„ Ù„Ù„Ù€${currentTeam === "green" ? "ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±" : "ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±"}`;
  questionText.textContent = q["Ø§Ù„Ø³Ø¤Ø§Ù„"];
  optionsEl.innerHTML = "";

  const opts = q["Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª"];
  const correct = q["Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©"];

  // Ø²Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø©
  let remain = 0;
  if(answerTimeSelect.value === "limited"){
    remain = Math.max(5, Number(answerTimeInput.value||30));
    timerEl.textContent = `â±ï¸ Ù…ØªØ¨Ù‚Ù‘ÙŠ: ${remain} Ø«Ø§Ù†ÙŠØ©`;
    timerId && clearInterval(timerId);
    timerId = setInterval(() => {
      remain--;
      timerEl.textContent = `â±ï¸ Ù…ØªØ¨Ù‚Ù‘ÙŠ: ${remain} Ø«Ø§Ù†ÙŠØ©`;
      if(remain <= 0){
        clearInterval(timerId);
        timerEl.textContent = "â±ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";
        setTimeout(() => closeOverlay("#questionModal"), 600);
      }
    }, 1000);
  } else {
    timerEl.textContent = "";
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
  ["A","B","C","D"].forEach(key => {
    if(typeof opts[key] === "undefined") return;
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.textContent = `${key}) ${opts[key]}`;
    btn.addEventListener("click", () => {
      const isCorrect = (key === correct);
      btn.classList.add(isCorrect ? "correct" : "wrong");
      // Ù‚ÙÙ„ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      Array.from(optionsEl.children).forEach(b => b.disabled = true);
      if(timerId) clearInterval(timerId);

      setTimeout(() => {
        closeOverlay("#questionModal");
        if(isCorrect){
          claimCell();
        } else {
          // Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©: ØªØ¨Ù‚Ù‰ Ø§Ù„Ø®Ù„ÙŠØ© ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ²Ø©
        }
      }, 650);
    });
    optionsEl.appendChild(btn);
  });

  openOverlay("#questionModal");
}

// ======== Ø­Ø¬Ø² Ø§Ù„Ø®Ù„ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø© ========
function claimCell(){
  if(!selectedCell || !currentTeam) return;
  const {row, col, el} = selectedCell;
  boardState[row][col] = currentTeam;
  el.classList.add(currentTeam === "green" ? "taken-green" : "taken-red");

  // ===== Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„Ø®Ù„ÙŠØ© =====
  el.animate([
    { transform: 'scale(1)', boxShadow: '0 0 0 0 rgba(0,0,0,0)' },
    { transform: 'scale(1.25)', boxShadow: '0 0 24px 8px #FFD700' },
    { transform: 'scale(1)', boxShadow: '0 0 0 0 rgba(0,0,0,0)' }
  ], {
    duration: 700,
    easing: 'ease-in-out'
  });
  playSound(currentTeam === "green" ? 'greenPoint' : 'redPoint');

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· (Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©)
  const greenCount = countCells("green");
  const redCount = countCells("red");
  greenScoreEl.textContent = greenCount;
  redScoreEl.textContent = redCount;

  // ÙØ­Øµ Ø§Ù„ÙÙˆØ²
  const winner = checkVictory();
  if(winner){
    // ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙˆØ² Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
    victoryTitle.textContent = "ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!";
    victoryMsg.textContent = winner === "green" ? "Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±: Ø£ÙƒÙ…Ù„ ØµÙÙ‹Ø§ Ø£ÙÙ‚ÙŠØ§Ù‹!" : "Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±: Ø£ÙƒÙ…Ù„ Ø¹Ù…ÙˆØ¯Ù‹Ø§ Ø±Ø£Ø³ÙŠÙ‹Ø§!";
    document.getElementById('victoryPlayers').textContent = winner === "green" ? "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±" : "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±";
    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù
    const honorList = document.getElementById('honorList');
    honorList.innerHTML = `<div style='text-align:center;color:#888'>${winner === "green" ? "ğŸŸ¢ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±" : "ğŸ”´ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±"} Ø§Ù„ÙØ§Ø¦Ø² ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©</div>`;
    openOverlay("#victoryModal");
    showCelebration(victoryMsg.textContent);
    playWinSoundSequence();
  }

  // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
  selectedCell = null;
  currentTeam = null;
}

function countCells(team){
  let cnt = 0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(boardState[r][c] === team) cnt++;
    }
  }
  return cnt;
}

// Ø§Ù„Ø£Ø®Ø¶Ø± ÙŠÙÙˆØ² Ø¨ØµÙ Ø£ÙÙ‚ÙŠ ÙƒØ§Ù…Ù„ â€” Ø§Ù„Ø£Ø­Ù…Ø± ÙŠÙÙˆØ² Ø¨Ø¹Ù…ÙˆØ¯ Ø±Ø£Ø³ÙŠ ÙƒØ§Ù…Ù„
function checkVictory(){
  // Ø£Ø®Ø¶Ø±: Ø£ÙŠ ØµÙ ÙƒÙ„Ù‡ "green"
  for(let r=0;r<ROWS;r++){
    let ok = true;
    for(let c=0;c<COLS;c++){
      if(boardState[r][c] !== "green"){ ok = false; break; }
    }
    if(ok) return "green";
  }
  // Ø£Ø­Ù…Ø±: Ø£ÙŠ Ø¹Ù…ÙˆØ¯ ÙƒÙ„Ù‡ "red"
  for(let c=0;c<COLS;c++){
    let ok = true;
    for(let r=0;r<ROWS;r++){
      if(boardState[r][c] !== "red"){ ok = false; break; }
    }
    if(ok) return "red";
  }
  return null;
}

function resetGameState(){
  boardState = Array.from({length: ROWS}, () => Array(COLS).fill(null));
  selectedCell = null;
  currentTeam = null;
  greenScoreEl.textContent = "0";
  redScoreEl.textContent = "0";
}


// ======== Ø£Ù†Ù…ÙŠØ´Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙˆØ² Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ========
const style = document.createElement('style');
style.textContent = `
  .victory-modal .victory-animation {
    font-size: 3rem;
    margin-bottom: 1rem;
    animation: bounce 2s infinite;
    text-align: center;
  }
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
  }
  .victory-modal .honor-board {
    background: #F1F5F9;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 2rem 0;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
  }
  .victory-modal .honor-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #FFD700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
`;
document.head.appendChild(style);

function showNotification(msg, type = 'info'){
  const bar = document.getElementById("notificationBar");
  bar.textContent = msg;
  bar.className = `notification-bar show ${type}`;
  playNotificationSound(type);
  setTimeout(() => bar.classList.remove("show"), 3000);
}

function showCelebration(message) {
  showNotification(message, 'celebrate');
  // Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ø­ØªÙØ§Ù„ÙŠØ© (confetti)
  if(window.confetti) window.confetti();
  // Ù…Ø¤Ø«Ø± Ø¨ØµØ±ÙŠ Ø¥Ø¶Ø§ÙÙŠ
  const celebrationEl = document.createElement("div");
  celebrationEl.className = "celebration-message";
  celebrationEl.textContent = message;
  document.body.appendChild(celebrationEl);
  setTimeout(() => { celebrationEl.classList.add("show"); }, 100);
  setTimeout(() => {
    celebrationEl.classList.remove("show");
    setTimeout(() => { document.body.removeChild(celebrationEl); }, 300);
  }, 3000);
}

// Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©
// showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
// showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
// showCelebration('ğŸ‰ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø± ÙØ§Ø²!');
</script>
</body>
</html>
