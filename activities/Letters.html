<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
<title>مسابقة الحروف (30 حرف) — نسخة UX محسّنة</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet" />
<style>
  :root{
    --oman-red:#DC143C;--oman-green:#228B22;--oman-gold:#FFD700;--oman-white:#fff;--oman-navy:#1B365D;
    --red-gradient:linear-gradient(135deg,#DC143C 0%,#B91C3C 50%,#991B1B 100%);
    --green-gradient:linear-gradient(135deg,#228B22 0%,#16A34A 50%,#15803D 100%);
    --navy-gradient:linear-gradient(135deg,#1B365D 0%,#1E40AF 50%,#1D4ED8 100%);
    --bg-primary:#F8FAFC;--bg-secondary:#F1F5F9;--text-primary:#0F172A;--text-secondary:#475569;--border-color:#E2E8F0;
    --shadow-light:0 1px 3px rgba(0,0,0,.08);--shadow-medium:0 6px 18px rgba(0,0,0,.12);--shadow-large:0 20px 40px rgba(0,0,0,.18);
    --transition-fast:.15s cubic-bezier(.2,.8,.2,1);--transition-normal:.3s cubic-bezier(.2,.8,.2,1);
    --font-family:'Cairo',sans-serif
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{font-family:var(--font-family);background:var(--bg-primary);color:var(--text-primary);margin:0}

  /* رأس اللعبة */
  .container{max-width:1200px;margin:0 auto;padding:1rem}
  .game-header{margin:1rem 0;padding:1rem 1.25rem;background:#fff;border:1px solid var(--border-color);border-radius:20px;box-shadow:var(--shadow-medium);display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;justify-content:space-between}
  .game-title{font-size:1.8rem;font-weight:900;background:var(--red-gradient);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin:.25rem 0}
  .game-subtitle{color:var(--text-secondary);font-weight:600}

  /* شريط التحكم السريع */
  .control-bar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .chip{display:inline-flex;gap:.5rem;align-items:center;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:999px;padding:.4rem .75rem;font-weight:700;box-shadow:var(--shadow-light)}
  .volume-slider{appearance:none;width:130px;height:6px;border-radius:6px;background:#e5e7eb;outline:none}
  .volume-slider::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--oman-gold);border:2px solid #d4af37;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.2)}
  .toggle{position:relative;width:52px;height:28px;background:#e5e7eb;border-radius:999px;cursor:pointer;border:1px solid var(--border-color)}
  .toggle::after{content:"";position:absolute;top:3px;right:3px;width:22px;height:22px;border-radius:50%;background:#fff;box-shadow:var(--shadow-light);transition:var(--transition-fast)}
  .toggle.active{background:linear-gradient(90deg,#16A34A,#22C55E)}
  .toggle.active::after{transform:translateX(-24px)}
  .btn{border:none;border-radius:12px;padding:.85rem 1.2rem;font-weight:800;cursor:pointer;transition:transform .18s cubic-bezier(.68,-0.55,.27,1.55), box-shadow .18s, filter .18s}
  .btn.primary{background:var(--red-gradient);color:#fff}
  .btn.secondary{background:var(--navy-gradient);color:#fff}
  .btn.success{background:var(--green-gradient);color:#fff}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .btn:focus-visible{outline:3px solid #facc15;outline-offset:2px}
  .btn:hover:not(:disabled){transform:translateY(-2px) scale(1.05);box-shadow:0 10px 24px #0000001a, 0 0 0 2px #ffd9001c inset}
  .btn:active:not(:disabled){transform:scale(.96)}

  /* لوحة الإعدادات */
  .settings{background:#fff;border:1px solid var(--border-color);border-radius:20px;box-shadow:var(--shadow-medium);padding:1rem;margin-top:.5rem}
  .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin:.75rem 0 1rem}
  .setting-group{display:flex;flex-direction:column;gap:.4rem}
  .setting-group label{font-weight:800}
  select,input{padding:.8rem;border:2px solid var(--border-color);border-radius:12px;font-family:var(--font-family)}
  select:focus,input:focus{outline:none;border-color:var(--oman-red);box-shadow:0 0 0 3px rgba(220,20,60,.1)}

  /* منطقة اللعبة */
  .game-area{display:grid;grid-template-columns:1fr 2fr 1fr;gap:1rem;margin-top:1rem}
  .team{background:#fff;border-radius:18px;border:3px solid var(--oman-green);padding:1rem;box-shadow:var(--shadow-medium);position:relative}
  .team.red{border-color:var(--oman-red)}
  .team .name{font-weight:800}
  .team .score{font-size:2.1rem;font-weight:900;margin:.35rem 0}
  .team .hint{color:var(--text-secondary);font-size:.95rem}
  .turn-indicator{position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:#fff;border:2px dashed var(--oman-gold);color:var(--oman-navy);font-weight:800;border-radius:999px;padding:.15rem .6rem;box-shadow:var(--shadow-light);display:none}
  .turn-indicator.show{display:inline-block}

  .board{background:#fff;border:1px solid var(--border-color);border-radius:18px;box-shadow:var(--shadow-medium);padding:1rem}
  .board h3{text-align:center;margin-bottom:.5rem}

  /* شبكة 6×5 */
  .hexagon-board{display:grid;grid-template-columns:repeat(6,1fr);gap:.45rem;max-width:640px;margin:0 auto}
  .cell{aspect-ratio:1;background:var(--bg-secondary);border:3px solid var(--border-color);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:900;cursor:pointer;transition:transform .22s cubic-bezier(.68,-0.55,.27,1.55), box-shadow .22s, background .22s, border-color .22s;user-select:none; position:relative}
  .cell:focus-visible{outline:3px solid #facc15;outline-offset:2px}
  .cell:hover{transform:translateY(-2px);box-shadow:var(--shadow-medium);border-color:var(--oman-gold)}
  .cell.taken-green{background:var(--green-gradient);border-color:var(--oman-green);color:#fff}
  .cell.taken-red{background:var(--red-gradient);border-color:var(--oman-red);color:#fff}
  .cell .pulse{position:absolute;inset:-6px;border-radius:20px;border:3px solid rgba(250,204,21,.75);animation:pulse 1.1s ease-out 2}
  @keyframes pulse{0%{opacity:1;transform:scale(.9)}100%{opacity:0;transform:scale(1.2)}}

  .hidden{display:none !important}

  /* Overlays/Modals */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:1rem;z-index:50}
  .overlay.show{display:flex}
  .modal{background:#fff;border-radius:16px;box-shadow:var(--shadow-large);max-width:560px;width:100%;padding:1rem 1.25rem}
  .modal .title{font-weight:900;font-size:1.25rem;margin-bottom:.6rem}
  .modal .actions{display:flex;gap:.5rem;justify-content:center;margin-top:.8rem;flex-wrap:wrap}
  .team-btn{padding:.8rem 1.2rem;border:none;border-radius:12px;color:#fff;font-weight:900;cursor:pointer}
  .team-btn.green{background:var(--green-gradient)}
  .team-btn.red{background:var(--red-gradient)}
  .options{display:grid;grid-template-columns:1fr;gap:.5rem;margin-top:.75rem}
  .opt{padding:.85rem 1rem;border:2px solid var(--border-color);border-radius:12px;background:#fff;cursor:pointer;text-align:right;font-weight:800;transition:transform .18s, box-shadow .18s}
  .opt:hover{border-color:var(--oman-red);transform:translateY(-1px);box-shadow:var(--shadow-light)}
  .opt.correct{background:var(--green-gradient);border-color:var(--oman-green);color:#fff}
  .opt.wrong{background:var(--red-gradient);border-color:var(--oman-red);color:#fff}
  .close{background:#eef2f7;border:none;border-radius:10px;padding:.5rem .8rem;cursor:pointer}

  /* عداد زمني دائري */
  .timer-wrap{display:flex;align-items:center;justify-content:center;margin-top:.5rem}
  .timer-circle{width:84px;height:84px;position:relative}
  .timer-circle svg{transform:rotate(-90deg)}
  .timer-circle .num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--oman-navy)}

  /* Toasts */
  .toast-area{position:fixed;bottom:18px;left:18px;display:flex;flex-direction:column;gap:.5rem;z-index:60}
  .toast{background:#fff;border:1px solid var(--border-color);border-left:6px solid var(--oman-gold);border-radius:12px;box-shadow:var(--shadow-medium);padding:.75rem 1rem;min-width:240px;max-width:320px}
  .toast .t-title{font-weight:900}
  .toast .t-msg{color:var(--text-secondary);font-size:.95rem}
  .toast.success{border-left-color:#22c55e}
  .toast.warn{border-left-color:#f59e0b}
  .toast.error{border-left-color:#ef4444}

  /* رسائل تفاعلية وسط الشاشة */
  .interactive-message{pointer-events:none}

  /* مودال الفوز + مؤثرات */
  .victory-modal{position:relative;overflow:visible;text-align:center}
  .victory-trophy{display:flex;justify-content:center;align-items:center;margin-bottom:.6rem}
  .trophy-img{width:92px;height:92px;filter:drop-shadow(0 8px 32px #FFD70088);animation:trophy-bounce 1.2s cubic-bezier(.68,-0.55,.27,1.55)}
  @keyframes trophy-bounce{0%{transform:scale(.2) translateY(-80px);opacity:0}60%{transform:scale(1.15) translateY(10px);opacity:1}80%{transform:scale(.95) translateY(-4px)}100%{transform:scale(1)}}

  /* كانفس المؤثرات */
  #fx-confetti,#fx-fireworks{position:fixed;inset:0;width:100vw;height:100vh;pointer-events:none;z-index:55}

  @media (max-width:1024px){.game-area{grid-template-columns:1fr}.hexagon-board{max-width:520px}}
  @media (max-width:480px){.hexagon-board{max-width:320px}.cell{font-size:1.1rem;border-radius:12px}}
</style>
</head>
<body>
  <!-- الأصوات -->
  <audio id="snd-win"     src="../assets/media/sounds/win.mp3" preload="auto"></audio>
  <audio id="snd-success" src="../assets/media/sounds/perfect-score.mp3" preload="auto"></audio>
  <audio id="snd-point"   src="../assets/media/sounds/select.mp3" preload="auto"></audio>
  <audio id="snd-click"   src="../assets/media/sounds/Click.mp3" preload="auto"></audio>

  <div class="container" aria-live="polite">
    <div class="game-header">
      <div>
        <div class="game-title">🧩 مسابقة الحروف — 30 حرف</div>
        <div class="game-subtitle">🟢 الأخضر يفوز بإكمال صف أفقي • 🔴 الأحمر يفوز بإكمال عمود رأسي</div>
      </div>
      <div class="control-bar">
        <div class="chip" title="مستوى الصوت">
          🔊 الصوت
          <input id="volumeRange" class="volume-slider" type="range" min="0" max="1" step="0.01" />
        </div>
        <div class="chip" title="كتم/تفعيل الصوت">
          كتم
          <div id="muteToggle" class="toggle" role="switch" aria-checked="false" tabindex="0"></div>
        </div>
        <button class="btn secondary" id="notifBtn" title="تفعيل إشعارات المتصفح">🔔 تفعيل الإشعارات</button>
      </div>
    </div>

    <div class="settings" id="settingsPanel">
      <div class="settings-grid">
        <div class="setting-group">
          <label>🏫 اختر المرحلة الدراسية</label>
          <select id="stageSelect" required>
            <option value="">-- اختر المرحلة --</option>
            <option value="الخامس">الصف الخامس</option>
            <option value="السادس">الصف السادس</option>
            <option value="السابع">الصف السابع</option>
            <option value="الثامن">الصف الثامن</option>
            <option value="التاسع">الصف التاسع</option>
          </select>
        </div>
        <div class="setting-group">
          <label>⏱️ زمن الإجابة</label>
          <select id="answerTimeSelect">
            <option value="unlimited">مفتوح</option>
            <option value="limited">محدد</option>
          </select>
          <input type="number" id="answerTimeInput" min="5" max="300" placeholder="عدد الثواني (مثلاً 30)" style="margin-top:.5rem;display:none">
        </div>
      </div>
      <div class="action-buttons" style="display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center">
        <button class="btn primary"   id="startGameBtn">▶️ ابدأ اللعبة</button>
        <button class="btn secondary" id="resetBtn">🔄 إعادة تعيين</button>
        <button class="btn" id="demoCorrectBtn" style="background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff">✨ تجربة احتفال الإجابة</button>
        <button class="btn" id="demoWinBtn" style="background:linear-gradient(135deg,#f59e0b,#eab308);color:#0F172A">🏆 تجربة احتفال الفوز</button>
      </div>
      <p style="margin-top:.6rem;color:var(--text-secondary)">
        ملاحظة: ضع هذا الملف وملف <b>questions_bank.json</b> في نفس المجلد.
      </p>
    </div>

    <div class="game-area hidden" id="gameArea">
      <div class="team" id="greenTeam">
        <div class="turn-indicator" id="turnGreen">دور الأخضر</div>
        <div class="name">🟢 الفريق الأخضر</div>
        <div class="score" id="greenScore">0</div>
        <div class="hint">🎯 أكمل صفاً أفقياً للفوز</div>
      </div>

      <div class="board">
        <h3>🎲 لوحة الحروف (6 × 5)</h3>
        <div class="hexagon-board" id="board"></div>
      </div>

      <div class="team red" id="redTeam">
        <div class="turn-indicator" id="turnRed">دور الأحمر</div>
        <div class="name">🔴 الفريق الأحمر</div>
        <div class="score" id="redScore">0</div>
        <div class="hint">🎯 أكمل عموداً رأسياً للفوز</div>
      </div>
    </div>
  </div>

  <!-- اختيار الفريق -->
  <div class="overlay" id="teamModal" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="title">اختيار الفريق</div>
      <p style="color:var(--text-secondary)">أي فريق سيحاول الإجابة على هذا الحرف؟</p>
      <div class="actions">
        <button class="team-btn green" id="chooseGreen">🟢 الفريق الأخضر</button>
        <button class="team-btn red" id="chooseRed">🔴 الفريق الأحمر</button>
      </div>
      <div class="actions"><button class="close" data-close="#teamModal">إغلاق</button></div>
    </div>
  </div>

  <!-- سؤال متعدد الخيارات -->
  <div class="overlay" id="questionModal" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="title" id="qTitle">السؤال</div>
      <div id="questionText" style="font-weight:800"></div>
      <div class="options" id="options"></div>

      <div class="timer-wrap" id="timerWrap" style="display:none">
        <div class="timer-circle">
          <svg width="84" height="84">
            <circle cx="42" cy="42" r="36" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
            <circle id="timerStroke" cx="42" cy="42" r="36" stroke="url(#grad)" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="226" stroke-dashoffset="0"></circle>
            <defs>
              <linearGradient id="grad" x1="0" x2="1" y1="0" y2="0">
                <stop offset="0%" stop-color="#22c55e"></stop>
                <stop offset="100%" stop-color="#dc2626"></stop>
              </linearGradient>
            </defs>
          </svg>
          <div class="num" id="timerNum">0</div>
        </div>
      </div>

      <div class="actions"><button class="close" data-close="#questionModal">إغلاق</button></div>
    </div>
  </div>

  <!-- فوز -->
  <div class="overlay" id="victoryModal" aria-modal="true" role="dialog">
    <div class="modal victory-modal">
      <div class="victory-trophy">
        <img src="../assets/media/images/trophy.png" alt="كأس الفوز" class="trophy-img">
      </div>
      <div class="title" id="victoryTitle">🎉 مبروك!</div>
      <p id="victoryMsg" style="text-align:center"></p>
      <div class="victory-explanation" id="victoryExplanation" style="text-align:center; margin:.8rem 0; font-size:1.05rem; color:#1B365D; font-weight:700;"></div>
      <div class="actions"><button class="btn success" data-close="#victoryModal">حسنًا</button></div>
    </div>
  </div>

  <!-- مناطق المؤثرات/التوست -->
  <canvas id="fx-confetti" class="hidden"></canvas>
  <canvas id="fx-fireworks" class="hidden"></canvas>
  <div class="toast-area" id="toastArea" aria-live="polite"></div>

<script>
/* =========================
   أدوات عامة + حفظ الإعدادات
========================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
const load = (k,def)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??def}catch{ return def }};

const letters30 = ["ا","ب","ت","ث","ج","ح","خ","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ع","غ","ف","ق","ك","ل","م","ن","ه","و","ي","ة","ء"];
const COLS=6, ROWS=5;

let boardState = Array.from({length: ROWS}, () => Array(COLS).fill(null));
let selectedCell = null;   // {row,col,el}
let currentTeam  = null;   // 'green' | 'red'
let currentStage = "";
let questionsDataByStage = {};
let timerId = null;
let remaining = 0;
let notificationsEnabled = false;

/* =========================
   نظام الصوت المحترف
========================= */
const audioMap = {
  win:     $("#snd-win"),
  success: $("#snd-success"),
  point:   $("#snd-point"),
  click:   $("#snd-click")
};
const volumeRange = $("#volumeRange");
const muteToggle  = $("#muteToggle");
function applyAudioPreferences(){
  const vol  = load('vol', 0.85);
  const mute = load('mute', false);
  volumeRange.value = vol;
  if(mute) muteToggle.classList.add('active');
  Object.values(audioMap).forEach(a=>{ if(a){ a.volume = mute?0:vol }});
}
applyAudioPreferences();

volumeRange.addEventListener('input', e=>{
  const val = Number(e.target.value);
  save('vol', val);
  Object.values(audioMap).forEach(a=>{ if(a){ a.volume = load('mute',false)?0:val }});
  toast('تم ضبط مستوى الصوت', `النسبة: ${(val*100)|0}%`, 'success');
});
function setMute(m){
  save('mute', !!m);
  if(m) muteToggle.classList.add('active'); else muteToggle.classList.remove('active');
  const vol = load('vol',0.85);
  Object.values(audioMap).forEach(a=>{ if(a){ a.volume = m?0:vol }});
}
muteToggle.addEventListener('click', ()=> setMute(!load('mute',false)));
muteToggle.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); setMute(!load('mute',false)) }});
function playSound(type){
  const a = audioMap[type] || audioMap.click;
  if(!a) return;
  try { a.currentTime=0; a.play(); } catch {}
}

/* =========================
   توست الإشعارات داخل التطبيق
========================= */
const toastArea = $("#toastArea");
function toast(title, msg='', kind='success', timeout=2200){
  const el = document.createElement('div');
  el.className = `toast ${kind}`;
  el.innerHTML = `<div class="t-title">${title}</div><div class="t-msg">${msg}</div>`;
  toastArea.appendChild(el);
  setTimeout(()=>{ el.style.transform='translateY(-4px)'; el.style.opacity='0';
    setTimeout(()=> el.remove(), 320);
  }, timeout);
}

/* =========================
   إشعارات المتصفح (اختياري)
========================= */
$("#notifBtn").addEventListener('click', async ()=>{
  if(!('Notification' in window)) { toast('المتصفح لا يدعم الإشعارات','','warn'); return; }
  const p = await Notification.requestPermission();
  notificationsEnabled = (p === 'granted');
  toast(notificationsEnabled?'تم تفعيل الإشعارات':'تم رفض الإشعارات','', notificationsEnabled?'success':'warn');
});
function pushNotification(title, body){
  if(!notificationsEnabled) return;
  try{ new Notification(title, { body, icon: '../assets/media/images/trophy.png' }); }catch{}
}

/* =========================
   رسائل تفاعلية وسط الشاشة
========================= */
let lastInteractiveMessageTime = 0;
let interactiveMessagesEnabled = true;
function showInteractiveMessage(messageText, soundType = 'success') {
  const now = Date.now();
  if (now - lastInteractiveMessageTime < 900) return;
  lastInteractiveMessageTime = now;
  if (!interactiveMessagesEnabled) return;

  const existing = document.querySelector('.interactive-message');
  if (existing) existing.remove();

  const msg = document.createElement('div');
  msg.className = 'interactive-message';
  msg.innerHTML = messageText;
  msg.style.cssText = `
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(.9);
    background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(240,248,255,.98));
    backdrop-filter: blur(14px); border: 2px solid #FFD700; border-radius: 20px;
    padding: 1.25rem 1.75rem; font-size: clamp(1.05rem, 5vw, 1.35rem); font-weight: 800;
    color: #1B365D; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,.2), 0 0 30px #FFD70040;
    z-index: 10000; opacity: 0; transition: all .38s cubic-bezier(.68,-0.55,.27,1.55);
    max-width: 90vw; word-wrap: break-word; font-family: 'Cairo',sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,.08);
  `;
  document.body.appendChild(msg);
  playSound(soundType);
  setTimeout(()=>{ msg.style.opacity='1'; msg.style.transform='translate(-50%,-50%) scale(1)';}, 30);
  setTimeout(()=>{ msg.style.opacity='0'; msg.style.transform='translate(-50%,-50%) scale(.95)'; setTimeout(()=>msg.remove(), 350); }, 2300);
}

/* =========================
   تحميل بنك الأسئلة
========================= */
fetch("questions_bank.json")
  .then(r => r.json())
  .then(json => {
    const arr = json["بنك الأسئلة"] || [];
    arr.forEach(group => { questionsDataByStage[group["الصف"]] = group["الأسئلة"]; });
    toast('تم تحميل بنك الأسئلة','جاهزون للعب!','success',1800);
  })
  .catch(err => {
    console.error("تعذر تحميل بنك الأسئلة:", err);
    toast('⚠️ لم يتم تحميل بنك الأسئلة','ضع questions_bank.json بجوار الملف','error',5000);
    alert("⚠️ لم يتم العثور على ملف بنك الأسئلة (questions_bank.json). ضع الملف بجوار هذه الصفحة.");
  });

/* =========================
   إنشاء اللوحة + تحسينات قابلية الاستخدام
========================= */
const boardEl = $("#board");
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]] } return a; }

function createBoard(){
  boardEl.innerHTML = "";
  const shuffled = shuffle(letters30);
  let i=0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const cell = document.createElement('button');
      cell.className = 'cell';
      cell.type = 'button';
      cell.setAttribute('aria-label', `حرف ${shuffled[i]}`);
      cell.dataset.r = r; cell.dataset.c = c;
      cell.textContent = shuffled[i++];
      cell.addEventListener('click', ()=> onCellClick(cell, r, c));
      cell.addEventListener('keydown', e=>{
        if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); onCellClick(cell, r, c); }
      });
      boardEl.appendChild(cell);
    }
  }
}

/* =========================
   بدء اللعبة / إعادة الضبط
========================= */
const settingsPanel = $("#settingsPanel");
const gameArea = $("#gameArea");
const stageSelect = $("#stageSelect");
const startGameBtn = $("#startGameBtn");
const resetBtn = $("#resetBtn");
const demoCorrectBtn = $("#demoCorrectBtn");
const demoWinBtn = $("#demoWinBtn");

const answerTimeSelect = $("#answerTimeSelect");
const answerTimeInput  = $("#answerTimeInput");
answerTimeSelect.addEventListener('change',()=>{
  answerTimeInput.style.display = answerTimeSelect.value === 'limited' ? 'block' : 'none';
});

startGameBtn.addEventListener('click', ()=>{
  currentStage = stageSelect.value;
  if(!currentStage){ toast('اختر المرحلة أولًا','','warn'); return; }
  const list = questionsDataByStage[currentStage] || [];
  if(list.length === 0){ toast('لا توجد أسئلة لهذه المرحلة','','error'); return; }

  settingsPanel.classList.add('hidden');
  gameArea.classList.remove('hidden');
  resetGameState();
  createBoard();
  showInteractiveMessage('🎮 بدأت الجولة! اختروا حرفًا للانطلاق');
  pushNotification('بدأت اللعبة', 'حظًا موفقًا للفريقين!');

  // إظهار دور البداية (اختياري)
  indicateTurn(null);
});

resetBtn.addEventListener('click', ()=> location.reload());

demoCorrectBtn.addEventListener('click', ()=>{
  showCelebrationEffect('success');
  showInteractiveMessage('✅ إجابة صحيحة! نقطة مستحقة', 'success');
  toast('أحسنت!','تم تسجيل النقطة','success');
});

demoWinBtn.addEventListener('click', ()=>{
  openVictory('green');
});

/* =========================
   اختيار الخلية والفريق
========================= */
const teamModal = $("#teamModal");
const chooseGreen = $("#chooseGreen");
const chooseRed = $("#chooseRed");
function openOverlay(id){ document.querySelector(id).classList.add('show'); }
function closeOverlay(id){ document.querySelector(id).classList.remove('show'); }
$$(".close").forEach(b=> b.addEventListener('click', e=> closeOverlay(b.getAttribute('data-close'))));

function onCellClick(cell, r, c){
  if(boardState[r][c]) return;
  selectedCell = {row:r, col:c, el:cell};
  playSound('point');
  cell.insertAdjacentHTML('beforeend','<span class="pulse"></span>');
  setTimeout(()=>{ const p = cell.querySelector('.pulse'); if(p) p.remove(); }, 1100);
  openOverlay('#teamModal');
}
chooseGreen.addEventListener('click', ()=>{ currentTeam='green'; closeOverlay('#teamModal'); askQuestion(); });
chooseRed .addEventListener('click', ()=>{ currentTeam='red';   closeOverlay('#teamModal'); askQuestion(); });

/* =========================
   عرض السؤال + عداد دائري
========================= */
const questionModal = $("#questionModal");
const qTitle = $("#qTitle");
const questionText = $("#questionText");
const optionsEl = $("#options");
const timerWrap = $("#timerWrap");
const timerStroke = $("#timerStroke");
const timerNum = $("#timerNum");

function askQuestion(){
  const list = questionsDataByStage[currentStage] || [];
  const q = list[(Math.random()*list.length)|0];
  renderQuestion(q);
}
function renderQuestion(q){
  qTitle.textContent = `سؤال للفريق ${currentTeam==='green'?'الأخضر':'الأحمر'}`;
  questionText.textContent = q["السؤال"];
  optionsEl.innerHTML = "";

  const opts = q["الخيارات"];
  const correct = q["الإجابة الصحيحة"];

  // زمن الإجابة
  if(answerTimeSelect.value === 'limited'){
    remaining = Math.max(5, Number(answerTimeInput.value || 30));
    timerWrap.style.display = 'flex';
    const circumference = 2 * Math.PI * 36; // r=36
    timerStroke.setAttribute('stroke-dasharray', circumference);
    let elapsed = 0;
    timerNum.textContent = remaining;
    timerStroke.style.transition = 'none';
    timerStroke.style.strokeDashoffset = '0';
    clearInterval(timerId);
    timerId = setInterval(()=>{
      elapsed++; remaining--;
      timerNum.textContent = Math.max(0, remaining);
      const ratio = elapsed / (elapsed + remaining);
      timerStroke.style.transition = 'stroke-dashoffset .95s linear';
      timerStroke.style.strokeDashoffset = `${(circumference * ratio)}`;
      if(remaining<=0){
        clearInterval(timerId);
        timerNum.textContent = '0';
        setTimeout(()=> closeOverlay('#questionModal'), 500);
        toast('انتهى الوقت','لم يتم اختيار إجابة','warn');
      }
    }, 1000);
  } else {
    timerWrap.style.display = 'none';
  }

  // خيارات الإجابات
  ["A","B","C","D"].forEach(key=>{
    if(typeof opts[key] === "undefined") return;
    const btn = document.createElement('button');
    btn.className = 'opt';
    btn.textContent = `${key}) ${opts[key]}`;
    btn.addEventListener('click', ()=>{
      const isCorrect = (key === correct);
      btn.classList.add(isCorrect?'correct':'wrong');
      $$(".opt").forEach(b=> b.disabled = true);
      if(timerId) clearInterval(timerId);

      setTimeout(()=>{
        closeOverlay('#questionModal');
        if(isCorrect){
          claimCell();
        } else {
          navigator.vibrate?.(120);
          showInteractiveMessage('❌ إجابة غير صحيحة، حظًا أوفر!', 'click');
          toast('إجابة خاطئة','الخلية ما تزال متاحة','warn');
          currentTeam = null; // إلغاء الدور
          indicateTurn(null);
        }
      }, 650);
    });
    optionsEl.appendChild(btn);
  });

  openOverlay('#questionModal');
}

/* =========================
   تسجيل الخلية + فحص الفوز
========================= */
const greenScoreEl = $("#greenScore");
const redScoreEl   = $("#redScore");
const turnGreen = $("#turnGreen");
const turnRed   = $("#turnRed");

function countCells(team){ return boardState.flat().filter(x=>x===team).length }
function indicateTurn(winner){
  // إظهار لمن انتقلت الأفضلية (اختياري): إن لم يوجد فريق حالي، أخفِ المؤشرَين
  turnGreen.classList.toggle('show', currentTeam==='green');
  turnRed.classList.toggle('show', currentTeam==='red');
  if(!currentTeam){ turnGreen.classList.remove('show'); turnRed.classList.remove('show'); }
  if(winner){ turnGreen.classList.remove('show'); turnRed.classList.remove('show'); }
}

function claimCell(){
  if(!selectedCell || !currentTeam) return;
  const {row,col,el} = selectedCell;
  boardState[row][col] = currentTeam;
  el.classList.add(currentTeam==='green'?'taken-green':'taken-red');
  el.setAttribute('aria-pressed','true');

  // نقاط
  greenScoreEl.textContent = countCells('green');
  redScoreEl.textContent   = countCells('red');

  // احتفال إجابة صحيحة
  showCelebrationEffect('success');
  toast('إجابة صحيحة!','تم حجز الخلية','success');
  navigator.vibrate?.([30,40,30]);

  // فحص الفوز
  const winner = checkVictory();
  if(winner){
    openVictory(winner);
  } else {
    // إنهاء الدور
    selectedCell = null;
    currentTeam = null;
    indicateTurn(null);
  }
}

function checkVictory(){
  // أخضر: أي صف كله "green"
  for(let r=0;r<ROWS;r++){
    let ok=true;
    for(let c=0;c<COLS;c++){ if(boardState[r][c]!=='green'){ ok=false; break; } }
    if(ok) return 'green';
  }
  // أحمر: أي عمود كله "red"
  for(let c=0;c<COLS;c++){
    let ok=true;
    for(let r=0;r<ROWS;r++){ if(boardState[r][c]!=='red'){ ok=false; break; } }
    if(ok) return 'red';
  }
  return null;
}

function openVictory(winner){
  const victoryModal = $("#victoryModal");
  $("#victoryTitle").textContent = "🎉 انتهت اللعبة!";
  $("#victoryMsg").textContent = winner==='green' ? "مبروك للفريق الأخضر: أكمل صفًا أفقيًا!" : "مبروك للفريق الأحمر: أكمل عمودًا رأسيًا!";
  $("#victoryExplanation").textContent = winner==='green'
    ? "الفريق الأخضر فاز لأنه أكمل صفًا أفقيًا بالكامل."
    : "الفريق الأحمر فاز لأنه أكمل عمودًا رأسيًا بالكامل.";

  showCelebrationEffect('win');
  playSound('win');
  pushNotification('🏆 فوز مستحق!', winner==='green'?'الأخضر أبدع!':'الأحمر تألق!');
  openOverlay('#victoryModal');
}

/* =========================
   مؤثرات احتفال: كونفيتي + ألعاب نارية
========================= */
function showCelebrationEffect(type='win'){
  // صوت
  playSound(type==='win' ? 'win' : 'success');

  // كونفيتي
  confettiBurst();
  // ألعاب نارية عند الفوز الكبير
  if(type==='win'){ fireworksShow(1800); }
}

function confettiBurst(){
  const canvas = $("#fx-confetti");
  const ctx = canvas.getContext('2d');
  const W = canvas.width = innerWidth, H = canvas.height = innerHeight;
  canvas.classList.remove('hidden');

  const N = 140;
  const items = Array.from({length:N}).map(()=>({
    x: Math.random()*W,
    y: -20 - Math.random()*40,
    r: 6 + Math.random()*8,
    d: 1.5 + Math.random()*2.2,
    c: `hsl(${Math.random()*360},90%,60%)`,
    t: Math.random()*10-5
  }));
  let frames=0, anim;
  (function draw(){
    ctx.clearRect(0,0,W,H);
    items.forEach(p=>{
      ctx.beginPath();
      ctx.ellipse(p.x,p.y,p.r,p.r/2,p.t,0,Math.PI*2);
      ctx.fillStyle=p.c; ctx.fill();
      p.y += p.d + Math.sin(frames/10 + p.x/100)*1.4;
      p.x += Math.sin(frames/15 + p.y/80)*2;
      p.t += Math.random()*0.2-0.1;
    });
    frames++;
    if(frames<100) anim=requestAnimationFrame(draw);
    else { cancelAnimationFrame(anim); setTimeout(()=>canvas.classList.add('hidden'), 400); }
  })();
}

function fireworksShow(duration=2000){
  const canvas = $("#fx-fireworks");
  const ctx = canvas.getContext('2d');
  const W = canvas.width = innerWidth, H = canvas.height = innerHeight;
  canvas.classList.remove('hidden');

  const particles=[];
  function boom(x,y,color){
    for(let i=0;i<60;i++){
      const a = Math.random()*Math.PI*2;
      const s = Math.random()*4+1.5;
      particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:60, color});
    }
  }
  let t=0, raf;
  (function loop(){
    ctx.fillStyle='rgba(0,0,0,0.15)';
    ctx.fillRect(0,0,W,H);
    particles.forEach((p,i)=>{
      p.x+=p.vx; p.y+=p.vy; p.vy+=0.03; p.life--;
      ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2);
      ctx.fillStyle=p.color; ctx.fill();
      if(p.life<=0) particles.splice(i,1);
    });
    if(t%25===0) boom(Math.random()*W, Math.random()*H*0.6, `hsl(${Math.random()*360},100%,60%)`);
    t++;
    if(t<duration/16){ raf=requestAnimationFrame(loop); }
    else { cancelAnimationFrame(raf); setTimeout(()=>canvas.classList.add('hidden'), 500); }
  })();
}

/* =========================
   تحسين تأثيرات الأزرار والخلايا
========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  // تأثير لجميع الأزرار
  $$('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      playSound('click');
      btn.animate([
        { transform:'scale(1)', boxShadow:'0 0 0 #FFD700' },
        { transform:'scale(1.12)', boxShadow:'0 0 16px #FFD700' },
        { transform:'scale(1)', boxShadow:'0 0 0 #FFD700' }
      ], { duration:320, easing:'cubic-bezier(.68,-0.55,.27,1.55)' });
    });
  });
});

/* =========================
   منطق الفوز وإعادة التعيين
========================= */
function resetGameState(){
  boardState = Array.from({length: ROWS}, () => Array(COLS).fill(null));
  selectedCell = null;
  currentTeam = null;
  $("#greenScore").textContent = '0';
  $("#redScore").textContent = '0';
}

/* =========================
   اختصارات لوحة المفاتيح
========================= */
document.addEventListener('keydown', e=>{
  // اختيار فريق سريعًا: G للأخضر / R للأحمر (عند فتح اختيار الفريق)
  if($("#teamModal").classList.contains('show')){
    if(e.key.toLowerCase()==='g'){ chooseGreen.click(); }
    if(e.key.toLowerCase()==='r'){ chooseRed.click(); }
  }
});

/* =========================
   تحسين تجربة الدور
========================= */
function setTeamTurn(team){ currentTeam = team; indicateTurn(null); }

/* =========================
   نهاية السكربت
========================= */
</script>
</body>
</html>
